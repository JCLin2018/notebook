# æ¢ç´¢çº¿ç¨‹å®‰å…¨æ€§èƒŒåçš„æœ¬è´¨ä¹‹volatile

## ä¸€ä¸ªå¯è§æ€§é—®é¢˜å¼•å‘çš„æ€è€ƒ

æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œå‘ç°ç¨‹åºä¸ä¼šæ‰§è¡Œç»“æŸï¼æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

```java
class JITDemo {
	public static boolean stop = false;
    public static void main(String[] args) throws InterruptedException {
        Thread thread=new Thread(()->{
            int i=0;
            while(!stop){
                i++;
            }
        });
        thread.start();
        Thread.sleep(1000);
        stop=true;
    }
}
```

#### printå°±å¯ä»¥å¯¼è‡´å¾ªç¯ç»“æŸ

```java
class JITDemo {
	public static boolean stop = false;
    public static void main(String[] args) throws InterruptedException {
        Thread thread=new Thread(()->{
            int i=0;
            while(!stop){
                i++;
                System.out.println("rs:"+i);
            }
        });
        thread.start();
        Thread.sleep(1000);
        stop=true;
    }
}
```

æ¦‚å¿µï¼šæ´»æ€§å¤±è´¥ï¼ŒJITæ·±åº¦ä¼˜åŒ–

```java
// åŸå§‹ä»£ç 
while(!stop){
    i++;
}
// JITä¼˜åŒ–åçš„ç»“æœ(åˆ¤æ–­å¤–æ)
if(!stop){
    while(true){
    	i++;
    }
}
```

è¿™é‡Œåˆ†ä¸ºä¸¤ä¸ªå±‚é¢æ¥è§£ç­”

- printlnåº•å±‚ç”¨åˆ°äº†synchronizedè¿™ä¸ªåŒæ­¥å…³é”®å­—ï¼Œè¿™ä¸ªåŒæ­¥ä¼šé˜²æ­¢å¾ªç¯æœŸé—´å¯¹äºstopå€¼çš„ç¼“å­˜ã€‚

- å› ä¸ºprintlnæœ‰åŠ é”çš„æ“ä½œï¼Œè€Œé‡Šæ”¾é”çš„æ“ä½œï¼Œä¼šå¼ºåˆ¶æ€§çš„æŠŠå·¥ä½œå†…å­˜ä¸­æ¶‰åŠåˆ°çš„å†™æ“ä½œåŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å»è¯æ˜ã€‚

  ```java
  Thread thread = new Thread(() -> {
      int i = 0;
      while(!stop) {
          i++;
          synchronized (JITDemo.class) {
          }
      }
  });
  ```

  

- ç¬¬ä¸‰ä¸ªè§’åº¦ï¼Œä»IOè§’åº¦æ¥è¯´ï¼Œprintæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªIOçš„æ“ä½œï¼Œæˆ‘ä»¬çŸ¥é“ç£ç›˜IOçš„æ•ˆç‡ä¸€å®šè¦æ¯”CPU çš„è®¡ç®—æ•ˆç‡æ…¢å¾—å¤šï¼Œæ‰€ä»¥IOå¯ä»¥ä½¿å¾—CPUæœ‰æ—¶é—´å»åšå†…å­˜åˆ·æ–°çš„äº‹æƒ…ï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªç°è±¡ã€‚æ¯”å¦‚ æˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢å®šä¹‰ä¸€ä¸ªnew File()ã€‚åŒæ ·ä¼šè¾¾åˆ°æ•ˆæœã€‚

  ```java
  Thread thread = new Thread(() -> {
      int i = 0;
      while(!stop) {
          i++;
          new File("txt.txt");
      }
  });
  ```

  ä¸Šè¿°çš„æƒ…å†µéƒ½æ˜¯é˜»æ­¢äº†JITè¿›è¡Œä¼˜åŒ–



#### æ·»åŠ `Thread.sleep(0)`ä¹Ÿå¯ä»¥ä½¿ç¨‹åºæ‰§è¡Œç»“æŸ

```java
class JITDemo {
    public static boolean stop = false;
    public static void main(String[] args) throws InterruptedException {
        Thread thread = new Thread(() -> {
            int i=0;
            while(!stop) {
                i++;
                try {
                    Thread.sleep(0);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        thread.start();
        Thread.sleep(1000);
        stop = true;
    }
}
```

> https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.3 
>
> åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å¢åŠ Thread.sleep(0)ä¹Ÿèƒ½ç”Ÿæ•ˆï¼Œè¿™ä¸ªæˆ‘è®¤ä¸ºæ˜¯å’Œcpuã€ä»¥åŠjvmã€æ“ä½œç³»ç»Ÿç­‰å› ç´  æœ‰å…³ç³»ã€‚ å®˜æ–¹æ–‡æ¡£ä¸Šæ˜¯è¯´ï¼ŒThread.sleepæ²¡æœ‰ä»»ä½•åŒæ­¥è¯­ä¹‰ï¼Œç¼–è¯‘å™¨ä¸éœ€è¦åœ¨è°ƒç”¨Thread.sleepä¹‹å‰æŠŠç¼“å­˜åœ¨å¯„ å­˜å™¨ä¸­çš„å†™åˆ·æ–°åˆ°ç»™å…±äº«å†…å­˜ã€ä¹Ÿä¸éœ€è¦åœ¨Thread.sleepä¹‹åé‡æ–°åŠ è½½ç¼“å­˜åœ¨å¯„å­˜å™¨ä¸­çš„å€¼ã€‚ ç¼–è¯‘å™¨å¯ä»¥è‡ªç”±é€‰æ‹©è¯»å–stopçš„å€¼ä¸€æ¬¡æˆ–è€…å¤šæ¬¡ï¼Œè¿™ä¸ªæ˜¯ç”±ç¼–è¯‘å™¨è‡ªå·±æ¥å†³å®šçš„ã€‚ ä½†æ˜¯åœ¨Micè€å¸ˆè®¤ä¸ºï¼šThread.sleep(0)å¯¼è‡´çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹åˆ‡æ¢ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆä»è€Œè¯»å–åˆ°äº†æ–°çš„å€¼ã€‚

#### æ·»åŠ volatileå±æ€§åŒæ ·ä¹Ÿèƒ½åˆ°æ—¶ç¨‹åºæ‰§è¡Œç»“æŸ

```java
class JITDemo {
    public static boolean stop = false;
    public volatile static int i = 0;
    public static void main(String[] args) throws InterruptedException {
        Thread thread=new Thread(()->{
            while(!stop){
                i++;
            }
        });
        thread.start();
        Thread.sleep(1000);
        stop=true;
    }
}

```



## ä½¿ç”¨volatileä¿è¯å¯è§æ€§

ä½¿ç”¨hsdiså·¥å…·

1. è§£å‹å‹ç¼©æ–‡ä»¶ï¼Œå°†è§£å‹çš„å†…å®¹ `hsdis-amd64.dll` `hsdis-amd64.lib`  æ”¾åˆ°`JRE_HOME/bin/server`è·¯å¾„ä¸‹
2. åœ¨è¿è¡Œmainå‡½æ•°ä¹‹å‰ï¼ŒåŠ å…¥è™šæ‹Ÿæœºå‚æ•°

```txt
-server -Xcomp -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:CompileCommand=compileonly,*App.getInstanceï¼ˆæ›¿æ¢æˆå®é™…è¿è¡Œçš„ä»£ç ï¼‰ 

# ä»¥JITDemoä¸ºä¾‹ï¼šJITDemoå†…æ‰€æœ‰æ–¹æ³•
-server -Xcomp -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:CompileCommand=compileonly,*JITDemo.*
```

é€šè¿‡å¯¹ä¸Šè¿°ä»£ç æŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤ï¼Œä½¿ç”¨hsdiså·¥å…·ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨volatileå…³é”®å­—ä¹‹åï¼Œå¤šäº†ä¸€ä¸ªLockæŒ‡ä»¤ã€‚

```txt
0x00000000037028f3: lock add dword ptr [rsp],0h ;*putstatic stop
```

```txt
0x0000000002b7ddab: push 0ffffffffc4834800h ;*putstatic stop; - com.example.threaddemo.VolatileDemo::<
```

> æ€è€ƒlockæ±‡ç¼–æŒ‡ä»¤æ¥ä¿è¯å¯è§æ€§é—®é¢˜?



## ä»ç¡¬ä»¶å±‚é¢åˆ†æå¯è§æ€§é—®é¢˜çš„æœ¬è´¨

### ä»€ä¹ˆæ˜¯å¯è§æ€§

åœ¨å•çº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œå¦‚æœå‘ä¸€ä¸ªå˜é‡å…ˆå†™å…¥ä¸€ä¸ªå€¼ï¼Œç„¶ååœ¨æ²¡æœ‰å†™å¹²æ¶‰çš„æƒ…å†µä¸‹è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œé‚£è¿™ä¸ªæ—¶å€™è¯»å–åˆ°çš„è¿™ä¸ªå˜é‡çš„å€¼åº”è¯¥æ˜¯ä¹‹å‰å†™å…¥çš„é‚£ä¸ªå€¼ã€‚è¿™æœ¬æ¥æ˜¯ä¸€ä¸ªå¾ˆæ­£å¸¸çš„äº‹æƒ…ã€‚ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œè¯»å’Œå†™å‘ç”Ÿåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°ï¼šè¯»çº¿ç¨‹ä¸èƒ½åŠæ—¶çš„è¯»å–åˆ°å…¶ä»–çº¿ç¨‹å†™å…¥çš„æœ€æ–°çš„å€¼ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¯è§æ€§

### ç¡¬ä»¶å±‚é¢

CPU/å†…å­˜/IOè®¾å¤‡

- CPUå±‚é¢å¢åŠ äº†é«˜é€Ÿç¼“å­˜
- æ“ä½œç³»ç»Ÿï¼Œè¿›ç¨‹ã€çº¿ç¨‹ã€| CPUæ—¶é—´ç‰‡æ¥åˆ‡æ¢
- ç¼–è¯‘å™¨çš„ä¼˜åŒ– ï¼Œæ›´åˆç†çš„åˆ©ç”¨CPUçš„é«˜é€Ÿç¼“å­˜

### CPUå±‚é¢çš„é«˜é€Ÿç¼“å­˜

å› ä¸ºé«˜é€Ÿç¼“å­˜çš„å­˜åœ¨ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªç¼“å­˜ä¸€è‡´æ€§é—®é¢˜

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_20-49-32.jpg)

**å› ä¸ºé«˜é€Ÿç¼“å­˜å­˜åœ¨ï¼Œæ‰ä¼šäº§ç”Ÿç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼ï¼ï¼**

### æ€»çº¿é”

æ€»çº¿é”ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œåœ¨å¤šcpuä¸‹ï¼Œå½“å…¶ä¸­ä¸€ä¸ªå¤„ç†å™¨è¦å¯¹å…±äº«å†…å­˜è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œåœ¨æ€»çº¿ä¸Šå‘å‡ºä¸€ä¸ªLOCK#ä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·ä½¿å¾—å…¶ä»–å¤„ç†å™¨æ— æ³•é€šè¿‡æ€»çº¿æ¥è®¿é—®åˆ°å…±äº«å†…å­˜ä¸­çš„æ•°æ®ï¼Œæ€»çº¿é”å®šæŠŠCPUå’Œå†…å­˜ä¹‹é—´çš„é€šä¿¡é”ä½äº†ï¼Œè¿™ä½¿å¾—é”å®šæœŸé—´ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½æ“ä½œå…¶ä»–å†…å­˜åœ°å€çš„æ•°æ®ï¼Œæ‰€ä»¥æ€»çº¿é”å®šçš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œè¿™ç§æœºåˆ¶æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ ã€‚ 

å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ

æœ€å¥½çš„æ–¹æ³•å°±æ˜¯æ§åˆ¶é”çš„ä¿æŠ¤ç²’åº¦ï¼Œæˆ‘ä»¬**åªéœ€è¦ä¿è¯å¯¹äºè¢«å¤šä¸ªCPUç¼“å­˜çš„åŒä¸€ä»½æ•°æ®æ˜¯ä¸€è‡´çš„å°±è¡Œ**ã€‚åœ¨P6æ¶æ„çš„CPUåï¼Œå¼•å…¥äº†ç¼“å­˜é”ï¼Œå¦‚æœå½“å‰æ•°æ®å·²ç»è¢«CPUç¼“å­˜äº†ï¼Œå¹¶ä¸”æ˜¯è¦å†™å…¥åˆ°ä¸»å†…å­˜ä¸­çš„ï¼Œå°±å¯ä»¥é‡‡ç”¨**ç¼“å­˜é”**æ¥è§£å†³é—®é¢˜ã€‚ 

### ç¼“å­˜é”

æŒ‡å†…å­˜åŒºåŸŸå¦‚æœè¢«ç¼“å­˜åœ¨å¤„ç†å™¨çš„ç¼“å­˜è¡Œä¸­ï¼Œå¹¶ä¸”åœ¨LockæœŸé—´è¢«é”å®šï¼Œé‚£ä¹ˆå½“å®ƒæ‰§è¡Œé”æ“ä½œå›å†™åˆ°å†…å­˜æ—¶ï¼Œä¸å†æ€»çº¿ä¸ŠåŠ é”ï¼Œè€Œæ˜¯ä¿®æ”¹å†…éƒ¨çš„å†…å­˜åœ°å€ï¼ŒåŸºäºç¼“å­˜ä¸€è‡´æ€§åè®®æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚

> æ€»çº¿é”å’Œç¼“å­˜é”æ€ä¹ˆé€‰æ‹©ï¼Œå–å†³äºå¾ˆå¤šå› ç´ ï¼Œæ¯”å¦‚CPUæ˜¯å¦æ”¯æŒã€ä»¥åŠå­˜åœ¨æ— æ³•ç¼“å­˜çš„æ•°æ®æ—¶ï¼ˆæ¯”è¾ƒå¤§æˆ–è€…å¿«çº¦å¤šä¸ªç¼“å­˜è¡Œçš„æ•°æ®ï¼‰ï¼Œå¿…ç„¶è¿˜æ˜¯ä¼šä½¿ç”¨æ€»çº¿é”ã€‚

### ç¼“å­˜ä¸€è‡´æ€§åè®®

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_20-53-17.jpg)

MSIã€MESIã€MOSI...

MESIæ ‡è¯†å››ç§ç¼“å­˜çŠ¶æ€ï¼š

- Modify ä¿®æ”¹
- Exclusive ç‹¬å 
- Shared å…±äº«
- Invalid å¤±æ•ˆ

**ç¼“å­˜ä¸€è‡´æ€§åè®®å·¥ä½œåŸç†**

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_21-09-04.jpg)

è§‚å¯Ÿä¸Šå›¾ï¼Œå¯ä»¥çœ‹åˆ°ç¼“å­˜ä¸€è‡´æ€§åè®®å­˜åœ¨é˜»å¡é—®é¢˜ï¼Œå¼•å‡ºäº†MESIçš„ä¸€ä¸ªä¼˜åŒ–é—®é¢˜

CPU0ä¿®æ”¹å˜é‡åå‘å‡ºinvalidateï¼ˆå¤±æ•ˆï¼‰æ“ä½œï¼Œä¼šç­‰å¾…CPU0è¿”å›ACKåæ‰èƒ½å°†æ•°æ®å†™å…¥ä¸»å†…å­˜ï¼Œè¿™æ—¶CPU0å°±æ˜¯é˜»å¡ï¼ˆå› ä¸ºæ˜¯å¼ºä¸€è‡´ï¼‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé˜»å¡é—®é¢˜ï¼Œè¯·çœ‹ä¸‹é¢ğŸ‘‡

#### Store Bufferes

Store Bufferesæ˜¯ä¸€ä¸ªå†™çš„ç¼“å†²ï¼Œå¯¹äºä¸Šè¿°æè¿°çš„æƒ…å†µï¼ŒCPU0å¯ä»¥å…ˆæŠŠå†™å…¥çš„æ“ä½œå…ˆå­˜å‚¨åˆ°Store Bufferesä¸­ï¼ŒStore Bufferesä¸­çš„æŒ‡ä»¤å†æŒ‰ç…§ç¼“å­˜ä¸€è‡´æ€§åè®®å»å‘èµ·å…¶ä»–CPUç¼“å­˜è¡Œçš„å¤±æ•ˆã€‚è€ŒCPU0è¿™æ—¶å¯ä»¥ä¸ç”¨é˜»å¡ç­‰å¾…CPU1çš„Ackï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œå…¶ä»–æŒ‡ä»¤ï¼Œç›´åˆ°æ”¶åˆ° Ackåå†å°†Store Bufferesæ•°æ®åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ã€‚

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_23-32-56.jpg)

å¼•å…¥Store Bufferesä¹‹åï¼Œå¯¼è‡´äº†æŒ‡ä»¤é‡æ’åºé—®é¢˜ã€‚å› ä¸ºä¸Šä¸€æ¬¡æ“ä½œæ²¡æœ‰åŠæ—¶å†™å…¥ä¸»å†…å­˜ï¼Œå°±å¼€å§‹ä¸‹ä¸€ä¸ªæ“ä½œã€‚

## MESIä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜

### æŒ‡ä»¤é‡æ’åº

æˆ‘ä»¬æ¥å…³æ³¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå‡è®¾åˆ†åˆ«æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ‰§è¡ŒexecuteToCPU0å’ŒexecuteToCPU1ï¼Œåˆ†åˆ«ç”±ä¸¤ä¸ªä¸åŒçš„CPUæ¥æ‰§è¡Œã€‚ 

å¼•å…¥Store Bufferesä¹‹åï¼Œå°±å¯èƒ½å‡ºç° b==1è¿”å›true ï¼Œä½†æ˜¯assert(a==1)è¿”å›falseã€‚è¿™ç§æƒ…å†µæ€ä¹ˆå¯èƒ½æˆç«‹ï¼Ÿ

```java
// ä¼ªä»£ç 
executeToCpu0() {
    a = 1;
    b = 1; 
    // ä»æ’åºåå¯èƒ½ä¼šè¿™æ ·
    // b = 1; 
    // a = 1; 
}

executeToCpu1() {
    while (b == 1) { // true
        assert (a == 1); // false
    }
}
```

![image-20210306160510612](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/general/20210306160510.png)

å‡å¦‚ï¼š
CPU0 å…ˆè¯»å–b=0ã€a=0ï¼›CPU1è¯»å–a=0;
CPU0ç‹¬å bå˜é‡ï¼ŒCPU0ã€CPU1å…±æŒæœ‰aå˜é‡

æ­¥éª¤ï¼š

1.CPU0å…ˆä¿®æ”¹aå˜é‡æ”¹æˆa=1ã€‚
2.å°†aå˜é‡å­˜å‚¨åœ¨store bufferä¸­
3.å‘é€read invalidateå‘½ä»¤ï¼ˆCPU1å¯¹aå˜é‡å¤±æ•ˆï¼‰
4.åœ¨è¿™è¿‡ç¨‹CPU0ä¸éœ€è¦ç­‰å¾…å…¶ä»–CPU1çš„ackï¼Œå¯ä»¥ç›´æ¥è®¡ç®—b=0ï¼Œå› ä¸ºbæ˜¯ç‹¬å çš„ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ã€‚
5.CPU1æ¥æ”¶åˆ°CPU0çš„read invalidateå‘½ä»¤ï¼Œå¯¹aå˜é‡è¿›è¡Œå¤±æ•ˆæ“ä½œï¼Œå°†aå˜é‡ç§»åˆ°invalidate queueï¼ˆå¤±æ•ˆé˜Ÿåˆ—ä¸­ï¼‰
6.CPU1è¿”å›invalidate ackï¼ˆè¿”å›ackå‘½ä»¤ï¼‰





### é€šè¿‡å†…å­˜å±éšœç¦æ­¢äº†æŒ‡ä»¤é‡æ’åº

#### ç¡¬ä»¶å±‚é¢

æŒ‡ä»¤é‡æ’åºç§ç±»ï¼š

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_23-49-37.jpg)

X86çš„memory barrieræŒ‡ä»¤åŒ…æ‹¬lfence(è¯»å±éšœ) sfence(å†™å±éšœ) mfence(å…¨å±éšœ) 

- Store Memory Barrier(å†™å±éšœ) ï¼Œå‘Šè¯‰å¤„ç†å™¨åœ¨å†™å±éšœä¹‹å‰çš„æ‰€æœ‰å·²ç»å­˜å‚¨åœ¨å­˜å‚¨ç¼“å­˜(store bufferes)ä¸­çš„æ•°æ®åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä½¿å¾—å†™å±éšœä¹‹å‰çš„æŒ‡ä»¤çš„ç»“æœå¯¹å±éšœä¹‹åçš„è¯»æˆ–è€…å†™æ˜¯å¯è§çš„ 
- Load Memory Barrier(è¯»å±éšœ) ï¼Œå¤„ç†å™¨åœ¨è¯»å±éšœä¹‹åçš„è¯»æ“ä½œï¼Œéƒ½åœ¨è¯»å±éšœä¹‹åæ‰§è¡Œã€‚é…åˆå†™å±éšœï¼Œä½¿å¾—å†™å±éšœä¹‹å‰çš„å†…å­˜æ›´æ–°å¯¹äºè¯»å±éšœä¹‹åçš„è¯»æ“ä½œæ˜¯å¯è§çš„ 
- Full Memory Barrier(å…¨å±éšœ) ï¼Œç¡®ä¿å±éšœå‰çš„å†…å­˜è¯»å†™æ“ä½œçš„ç»“æœæäº¤åˆ°å†…å­˜ä¹‹åï¼Œå†æ‰§è¡Œå±éšœåçš„è¯»å†™æ“ä½œ

```java
volatile int a = 0;
executeToCpu0() {
    a=1;
    //storeMemoryBarrier() ä¿®æ”¹aåï¼Œå†™å±éšœï¼Œå†™å…¥åˆ°å†…å­˜
    b=1;
    // CPUå±‚é¢çš„é‡æ’åº
    //b=1;
    //a=1;
}
executeToCpu1() {
    while(b == 1) { //true
        loadMemoryBarrier(); // åœ¨è¯»å–Aä¹‹å‰ï¼Œæ·»åŠ è¯»å±éšœ
        assert(a == 1) //false
    }
}
```

#### è½¯ä»¶å±‚é¢

ç¡¬ä»¶å±‚é¢ç”¨åˆ°äº†ä¸Šè¿°æŒ‡ä»¤ï¼Œåœ¨è½¯ä»¶å±‚é¢ï¼ŒJVMåŸºäºç¡¬ä»¶å±‚é¢çš„æŒ‡ä»¤ï¼Œå°è£…äº†ä¸€ä¸‹å››ä¸ªæŒ‡ä»¤

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_23-50-55.jpg)

```java
volatile int a = 0;
executeToCpu0() {
    a=1;
    storeload(); //ä¿®æ”¹aåï¼ŒJVMè‡ªåŠ¨æ·»åŠ è½¯ä»¶å±‚é¢çš„ å†…å­˜å±éšœ æŒ‡ä»¤
    b=1;
}
executeToCpu1() {
    while(b==1) {
        assert(a==1)
    }
}
```



### Q&A

**ä¸ºå•¥è¾“å‡ºçš„æ±‡ç¼–æŒ‡ä»¤åªæœ‰`lock`è€Œæ²¡æœ‰`Store ` ï¼Ÿ**

ä¸åŒCPUæ¶æ„é—®é¢˜ï¼ŒX86æ˜¯å¼ºä¸€è‡´æ€§æ¶æ„



## ä»JMMå±‚é¢äº†è§£å¯è§æ€§

ç®€å•æ¥è¯´ï¼ŒJMMå®šä¹‰äº†å…±äº«å†…å­˜ä¸­å¤šçº¿ç¨‹ç¨‹åºè¯»å†™æ“ä½œçš„è¡Œä¸ºè§„èŒƒï¼šåœ¨è™šæ‹Ÿæœºä¸­æŠŠå…±äº«å˜é‡å­˜å‚¨åˆ°å†…å­˜ä»¥åŠä»å†…å­˜ä¸­å–å‡ºå…±äº«å˜é‡çš„åº•å±‚å®ç°ç»†èŠ‚ã€‚é€šè¿‡è¿™äº›è§„åˆ™æ¥è§„èŒƒå¯¹å†…å­˜çš„è¯»å†™æ“ä½œä»è€Œä¿è¯æŒ‡ä»¤çš„æ­£ç¡®æ€§ï¼Œå®ƒè§£å†³äº†CPUå¤šçº§ç¼“å­˜ã€å¤„ç†å™¨ä¼˜åŒ–ã€æŒ‡ä»¤é‡æ’åºå¯¼è‡´çš„å†…å­˜è®¿é—®é—®é¢˜ï¼Œä¿è¯äº†å¹¶å‘åœºæ™¯ä¸‹çš„å¯è§æ€§ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJMMå¹¶æ²¡æœ‰ä¸»åŠ¨é™åˆ¶æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤„ç†å™¨çš„å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜æ¥æå‡æŒ‡ä»¤æ‰§è¡Œé€Ÿåº¦ï¼Œä¹Ÿæ²¡ä¸»åŠ¨é™åˆ¶ç¼–è¯‘å™¨å¯¹äºæŒ‡ä»¤çš„é‡æ’åºï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨JMMè¿™ä¸ªæ¨¡å‹ä¹‹ä¸Šï¼Œä»ç„¶ä¼šå­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å’ŒæŒ‡ä»¤é‡æ’åºé—®é¢˜ã€‚JMMæ˜¯ä¸€ä¸ªæŠ½è±¡æ¨¡å‹ï¼Œå®ƒæ˜¯å»ºç«‹åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶å±‚é¢ä¹‹ä¸Šå¯¹é—®é¢˜è¿›è¡Œäº†ç»Ÿä¸€çš„æŠ½è±¡ï¼Œç„¶åå†Javaå±‚é¢æä¾›äº†ä¸€äº›é«˜çº§æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼švolatileã€finalç­‰ç­‰ï¼Œè®©ç”¨æˆ·é€‰æ‹©åœ¨åˆé€‚çš„æ—¶å€™å»å¼•å…¥è¿™äº›é«˜çº§æŒ‡ä»¤æ¥è§£å†³å¯è§æ€§é—®é¢˜ã€‚

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_23-59-21.jpg)



![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_23-59-28.jpg)



### JMMæ˜¯å¦‚ä½•è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜çš„

å…¶å®é€šè¿‡å‰é¢çš„å†…å®¹åˆ†ææˆ‘ä»¬å‘ç°ï¼Œå¯¼è‡´å¯è§æ€§é—®é¢˜æœ‰ä¸¤ä¸ªå› ç´ ï¼Œ

- ä¸€ä¸ªæ˜¯é«˜é€Ÿç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜ï¼Œ 
- å¦ä¸€ä¸ªæ˜¯æŒ‡ä»¤é‡æ’åºã€‚

é‚£JMMæ˜¯å¦‚ä½•è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜çš„å‘¢ï¼Ÿ 

å…¶å®å‰é¢åœ¨åˆ†æç¡¬ä»¶å±‚é¢çš„å†…å®¹æ—¶ï¼Œå·²ç»æåˆ°è¿‡äº†ï¼Œå¯¹äºç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ‰æ€»çº¿é”å’Œç¼“å­˜é”ï¼Œç¼“å­˜é”æ˜¯åŸºäºMESIåè®®ã€‚è€Œå¯¹äºæŒ‡ä»¤é‡æ’åºï¼Œç¡¬ä»¶å±‚é¢æä¾›äº†å†…å­˜å±éšœæŒ‡ä»¤ã€‚è€ŒJMMåœ¨è¿™ä¸ªåŸºç¡€ä¸Šæä¾›äº†volatileã€finalç­‰å…³é”®å­—ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥åœ¨åˆé€‚çš„æ—¶å€™å¢åŠ ç›¸åº”ç›¸åº”çš„å…³é”®å­—æ¥ç¦æ­¢é«˜é€Ÿç¼“å­˜å’Œç¦æ­¢ æŒ‡ä»¤é‡æ’åºæ¥è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜ã€‚

## ä»javaä¸­å›å½’åˆ°Volatileçš„æœ¬è´¨

### VolatileåŸç†

> é€šè¿‡javap -v JITDemo.class

åœ¨æ·»åŠ äº†volatileåä¼šå‡ºç°ACC_VOLATILE

```
public static volatile boolean stop; // stopå˜é‡
    descriptor: Z
    flags: ACC_PUBLIC, ACC_STATIC, ACC_VOLATILE // æ·»åŠ ACC_VOLATILEå±æ€§
    ...
    
    23: iconst_1
    24: putstatic    #9 	// Field stop:Z
    27: return
 LineNumbnerTabnle:
 ...
```

é€šè¿‡æŸ¥çœ‹JVMæºç å¯ä»¥çœ‹å‡ºï¼š

```cpp
// bytecodeInterpreter.cpp
CASE(_putfield):
CASE(_putstatic):
	{
        ...

int field_offset = cache->f2_as_index();
    if (cache->is_volatile()) { // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨volatile
        if (tos_type == itos) {
        	obj->release_int_field_put(field_offset, STACK_INT(-1));
        } else if (tos_type == atos) {
            VERIFY_OOP(STACK_OBJECT(-1));
            obj->release_obj_field_put(field_offset, STACK_OBJECT(-1));
            OrderAccess::release_store(&BYTE_MAP_BASE[(uintptr_t)obj >>
            CardTableModRefBS::card_shift], 0);
        } else if (tos_type == btos) {
            obj->release_byte_field_put(field_offset, STACK_INT(-1));
        } else if (tos_type == ltos) {
            obj->release_long_field_put(field_offset, STACK_LONG(-1));
        } else if (tos_type == ctos) {
            obj->release_char_field_put(field_offset, STACK_INT(-1));
        } else if (tos_type == stos) {
            obj->release_short_field_put(field_offset, STACK_INT(-1));
        } else if (tos_type == ftos) {
            obj->release_float_field_put(field_offset, STACK_FLOAT(-1));
        } else {
            obj->release_double_field_put(field_offset, STACK_DOUBLE(-1));
        }
    	OrderAccess::storeload(); // ä»£ç æ‰§è¡Œæœ€åï¼Œæ·»åŠ storeload å†…å­˜å±éšœæŒ‡ä»¤
	}
...

```

is_volatile å±æ€§æŸ¥çœ‹ï¼š

```hpp
// accessFlags.hpp
public :
	// Java access flags
	bool is_public () const { return (_flag & JVM_ACC_PUBLIC ) != 0; }
	...
    bool is_volatile () const { return (_flag & JVM_ACC_VOLATILE ) != 0; }
	...
```

jvmå±‚é¢çš„å†…å­˜å±éšœï¼š

```hpp
// orderAccess_linux_x86.inline.hpp
// Implementation of class OrderAccess.
inline void OrderAccess::loadload() { acquire(); }
inline void OrderAccess::storestore() { release(); }
inline void OrderAccess::loadstore() { acquire(); }
inline void OrderAccess::storeload() { fence(); }
```

jvmçš„fenceæ“ä½œï¼š

```hpp
// orderAccess_linux_x86.inline.hpp
inline void OrderAccess::fence() { 
	if (os::is_MP) {//æ˜¯å¦å¤šæ ¸
        #ifdef AMD64:
        	__asm__ volatile ("lock; addl $0,0(%%rsp)" : : : "cc", "memory") 
        #else
        	__asm__ volatile ("lock; addl $0,0(%%esp)" : : : "cc", "memory") 
        #endif
    }
}
```



## Happens-Beforeå¯è§æ€§æ¨¡å‹

é™¤äº†æ˜¾ç¤ºå¼•ç”¨volatileå…³é”®å­—èƒ½å¤Ÿä¿è¯å¯è§æ€§ä»¥å¤–ï¼Œåœ¨Javaä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šçš„å¯è§æ€§ä¿éšœçš„è§„åˆ™ï¼ˆåœ¨ä¸€ä¸‹æ¡ä»¶ä¸‹ï¼Œå¯ä»¥ä¸éœ€è¦æ·»åŠ volatileå…³é”®å­—ä¹Ÿèƒ½å®ç°å¯è§æ€§ï¼‰ã€‚

ä»JDK1.5å¼€å§‹ï¼Œå¼•å…¥äº†ä¸€ä¸ªhappens-beforeçš„æ¦‚å¿µæ¥é˜è¿°å¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«å˜é‡çš„å¯è§æ€§é—®é¢˜ã€‚æ‰€ä»¥ æˆ‘ä»¬å¯ä»¥è®¤ä¸ºåœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œè¯¾ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œå¿…é¡»è¦å­˜åœ¨ happens-beforeå…³ç³»ã€‚è¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„çº¿ç¨‹ã€‚

### ç¨‹åºé¡ºåºè§„åˆ™ï¼ˆas-if-serialè¯­ä¹‰ï¼‰

- ä¸èƒ½æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœ(åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œçš„ç»“æœä¸å˜.)

- ä¾èµ–é—®é¢˜ï¼Œ å¦‚æœä¸¤ä¸ªæŒ‡ä»¤å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œæ˜¯ä¸å…è®¸é‡æ’åº

  ```java
  int a=0;
  int b=0;
  void test(){
      int a = 1; a
      int b = 1; b
      //int b = 1;
      //int a = 1;
      int c = a * b; c
  }
  ```

  a happens -before b ; b happens before c

### ä¼ é€’æ€§è§„åˆ™

a happens-before b , b happens- before c, a happens-before c

### volatileå˜é‡è§„åˆ™

volatile ä¿®é¥°çš„å˜é‡çš„å†™æ“ä½œï¼Œä¸€å®šhappens-beforeåç»­å¯¹äºvolatileå˜é‡çš„è¯»æ“ä½œ. å†…å­˜å±éšœæœºåˆ¶æ¥é˜²æ­¢æŒ‡ä»¤é‡æ’



ä»¥ä¸‹ä»£ç  å¾—å‡ºç»“æœ i ä¼šç­‰äº1 å—ï¼Ÿ

```java
public class VolatileExample{
    int a=0;
    volatile boolean flag=false;
    public void writer(){
        a=1; // æ­¥éª¤ 1
        flag=true; //æ­¥éª¤ 2
        }
        public void reader(){
        if(flag){ // æ­¥éª¤ 3
        	int i=a; // æ­¥éª¤ 4
        }
    }
}
```

1 happens-before 2 æ˜¯å¦æˆç«‹ï¼Ÿ æ˜¯ 

åŸå› ï¼šåœ¨ç¬¬ä¸€ä¸ªæ“ä½œæ™®é€šå†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œé‡æ’åº

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-15_23-51-03.jpg)

3 happens-before 4 æ˜¯å¦æˆç«‹? æ˜¯

åŸå› ï¼šæ ¹æ® ç¨‹åºé¡ºåºè§„åˆ™ å¾—å‡º

---

2 happens -before 3 æ˜¯å¦æˆç«‹ï¼Ÿ æ˜¯

åŸå› ï¼šæ ¹æ® volatileè§„åˆ™

æ ¹æ® ä¼ é€’æ€§è§„åˆ™ å¾—å‡ºç»“è®ºï¼š

1 happens-before 4 ; i=1æˆç«‹.

### ç›‘è§†å™¨é”è§„åˆ™ï¼ˆåŠ é”åï¼Œxå˜é‡ä¸€å®šæ˜¯å¯è§çš„ï¼‰

```java
int x=10;
synchronized(this){
    //åç»­çº¿ç¨‹è¯»å–åˆ°çš„xçš„å€¼ä¸€å®š12
    if(x<12){
    	x=12;
    }
}
x=12;
```

### startè§„åˆ™ï¼ˆåœ¨startä¹‹å‰ï¼Œå˜é‡xä¸€å®šæ˜¯å¯è§çš„ï¼‰

```java
public class StartDemo{
    int x=0;
    Thread t1=new Thread(()->{
        //è¯»å–xçš„å€¼ ä¸€å®šæ˜¯20
        if(x==20){
        }
    });
    x=20;
    t1.start();
}
```

### Joinè§„åˆ™ ï¼ˆjoin ä¹‹å‰ï¼Œå˜é‡xä¸€å®šæ˜¯å¯è§çš„ï¼‰

```java
public class Test{
    int x=0;
    Thread t1=new Thread(()->{
    	x=200;
    });
    t1.start();
    t1.join(); //ä¿è¯ç»“æœçš„å¯è§æ€§ã€‚ 
    //åœ¨æ­¤å¤„è¯»å–åˆ°çš„xçš„å€¼ä¸€å®šæ˜¯200.
    System.out.println("x:" + x)
}
```

join()æ€ä¹ˆå®ç°å¯è§æ€§ï¼Ÿ

![](https://notebook1.oss-cn-shenzhen.aliyuncs.com/img/Concurrence/Snipaste_2020-09-16_21-45-02.jpg)

```java
public final synchronized void join(long millis)
    throws InterruptedException {
        long base = System.currentTimeMillis();
        long now = 0;

        if (millis < 0) {
            throw new IllegalArgumentException("timeout value is negative");
        }

        if (millis == 0) {
            while (isAlive()) {
                wait(0); // è¿™é‡Œç”¨ äº† wait()
            }
        } else {
            while (isAlive()) {
                long delay = millis - now;
                if (delay <= 0) {
                    break;
                }
                wait(delay);  // è¿™é‡Œç”¨ äº† wait()
                now = System.currentTimeMillis() - base;
            }
        }
    }
```

é‚£ä¹ˆT1çº¿ç¨‹æ‰§è¡Œå®Œå¦‚ä½•æ‰§è¡Œnotify()æ–¹æ³•å‘¢ï¼Ÿ

åœ¨hotspotä¸­å¯ä»¥çœ‹åˆ°  thread.cpp

```cpp
// For any new cleanup additions, please check to see if they need to be applied to
// cleanup_failed_attach_current_thread as well.
void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
  assert(this == JavaThread::current(),  "thread consistency check");

  HandleMark hm(this);
  Handle uncaught_exception(this, this->pending_exception());
  this->clear_pending_exception();
  Handle threadObj(this, this->threadObj());
  assert(threadObj.not_null(), "Java thread object should be created");

  if (get_thread_profiler() != NULL) {
    get_thread_profiler()->disengage();
    ResourceMark rm;
    get_thread_profiler()->print(get_thread_name());
  }


  ......

  // Notify waiters on thread object. This has to be done after exit() is called
  // on the thread (if the thread is the last thread in a daemon ThreadGroup the
  // group should have the destroyed bit set before waiters are notified).
  ensure_join(this);  // è¿™é‡Œå”¤é†’ä¹‹å‰ æ‰§è¡Œjoinæ“ä½œçš„çº¿ç¨‹
  assert(!this->has_pending_exception(), "ensure_join should have cleared");

  ........

  // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
  Threads::remove(this);
}



static void ensure_join(JavaThread* thread) {
  // We do not need to grap the Threads_lock, since we are operating on ourself.
  Handle threadObj(thread, thread->threadObj());
  assert(threadObj.not_null(), "java thread object must exist");
  ObjectLocker lock(threadObj, thread);
  // Ignore pending exception (ThreadDeath), since we are exiting anyway
  thread->clear_pending_exception();
  // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
  java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
  // Clear the native thread instance - this makes isAlive return false and allows the join()
  // to complete once we've done the notify_all below
  java_lang_Thread::set_thread(threadObj(), NULL);
  lock.notify_all(thread); // è¿™é‡Œæ‰§è¡Œ notifyAllæ–¹æ³•å”¤é†’å»ä¸ç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹
  // Ignore pending exception (ThreadDeath), since we are exiting anyway
  thread->clear_pending_exception();
}
```

å¦å¤–ï¼Œfinalå…³é”®å­—æä¾›äº†å†…å­˜å±éšœçš„è§„åˆ™.